C51 COMPILER V8.06   IIC                                                                   07/12/2020 11:51:06 PAGE 1   


C51 COMPILER V8.06, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN IIC.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE IIC.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include<reg52.h>
   2          #include<intrins.h>
   3          #define uint unsigned int
   4          #define uchar unsigned char
   5          sbit W_LE=P2^7;
   6          sbit D_LE=P2^6;
   7          sbit SCL=P2^1;
   8          sbit SDA=P2^0;
   9          uchar num;
  10          bit ACKflag;
  11          uchar code Wei[]={0xfe,0xfb,0xfd,0xf7,0xef,0xdf,0xbf,0x7f};
  12          uchar code Duan[]={0x3F, 0x06, 0x5B,0x4F,0x66,0x6D,0x7D,0x07,0x7F, 0x6F};
  13          void delay5us()
  14          {
  15   1              _nop_();_nop_();_nop_();_nop_();_nop_();
  16   1      }
  17          void delay1(uint z)
  18          {
  19   1              uint y;
  20   1              for(;z>0;z--)
  21   1                      for(y=114;y>0;y--);
  22   1      }
  23          void display(uchar j)
  24          {
  25   1              static uchar i=5;
  26   1              P0=0xff;
  27   1              W_LE=1;
  28   1              P0=Wei[i];
  29   1              W_LE=0;
  30   1              switch(i)
  31   1              {
  32   2                      case 5: D_LE=1;P0=Duan[j/100];D_LE=0;break;
  33   2                      case 6: D_LE=1;P0=Duan[j%100/10];D_LE=0;break;
  34   2                      case 7: D_LE=1;P0=Duan[j%10];D_LE=0;break;
  35   2               }
  36   1              i++;
  37   1              if(i>7)
  38   1                      i=5;
  39   1      }
  40          void time0Init()   //定时计数器0工作模式1初始化
  41          {
  42   1              TMOD|=0x01;
  43   1              TR0=1;
  44   1              ET0=1;
  45   1              TH0=0xee;
  46   1              TL0=0x00;
  47   1      }
  48          
  49          void IICStart()   //起始信号
  50          {
  51   1              SCL=1;
  52   1              SDA=1;
  53   1              delay5us();
  54   1              SDA=0;
  55   1              delay5us();
C51 COMPILER V8.06   IIC                                                                   07/12/2020 11:51:06 PAGE 2   

  56   1      }
  57          void IICStop()   //终止信号
  58          {
  59   1              SCL=0;
  60   1              SDA=0;
  61   1              SCL=1;
  62   1              delay5us();
  63   1              SDA=1;
  64   1              delay5us();
  65   1      }
  66          bit ReadACK()    //主机读应答
  67          {
  68   1              SCL=0;
  69   1              SCL=1;
  70   1              delay5us();
  71   1              if(SDA)
  72   1              {
  73   2                      SCL=0;
  74   2                      return(1);
  75   2              }
  76   1              else
  77   1              {
  78   2                      SCL=0;
  79   2                      return(0);
  80   2              }
  81   1      }
  82          void SendACK(bit i)       //主机发送应答
  83          {
  84   1              SCL=0;
  85   1              if(i)
  86   1              {
  87   2                      SDA=1;
  88   2              }
  89   1              else 
  90   1                      SDA=0;
  91   1              SCL=1;
  92   1              delay5us();
  93   1              SCL=0;
  94   1              SDA=1;
  95   1      }
  96          
  97          
  98          
  99          
 100          //依次写入一个字节的数
 101          void SendByte(uchar dat)
 102          {
 103   1              uchar i;
 104   1              for(i=0;i<8;i++)
 105   1              {
 106   2                      SCL=0;
 107   2                      if(dat & 0x80)
 108   2                              SDA=1;
 109   2                      else 
 110   2                              SDA=0;
 111   2                      SCL=1;
 112   2                      dat<<=1;
 113   2              }
 114   1              SCL=0;
 115   1              SDA=1;    //释放数据总线
 116   1      }
 117          //主机往从机里写数据
C51 COMPILER V8.06   IIC                                                                   07/12/2020 11:51:06 PAGE 3   

 118          void Write(uchar address,dat)
 119          {
 120   1              IICStart();
 121   1              SendByte(0xa0+0);  //发送从机地址和写方向
 122   1              if(ReadACK())  //判断从机是否应答
 123   1                      ACKflag=1;
 124   1              else 
 125   1                      ACKflag=0;
 126   1              SendByte(address); //写入首地址
 127   1              if(ReadACK())  //判断从机是否应答
 128   1                      ACKflag=1;
 129   1              else 
 130   1                      ACKflag=0;
 131   1              SendByte(dat);
 132   1              if(ReadACK())  //判断从机是否应答
 133   1                      ACKflag=1;
 134   1              else 
 135   1                      ACKflag=0;
 136   1              IICStop();
 137   1      }
 138          
 139          
 140          
 141          
 142          
 143          //一个字节的数依次读出
 144          uchar ReceiveByte()      //有返回值
 145          {
 146   1              uchar i,dat;
 147   1              for(i=0;i<8;i++)
 148   1              {
 149   2                      dat<<=1;
 150   2                      SCL=0;
 151   2                      SCL=1;
 152   2                      if(SDA)
 153   2                              dat|=0x01;
 154   2              }
 155   1              return(dat);
 156   1      }
 157          //主机从从机中读取
 158          uchar Read(uchar address)          //有返回值
 159          {
 160   1              uchar dat;
 161   1              IICStart();
 162   1              SendByte(0xa0+0);  //发送从机地址和读写方向
 163   1              if(ReadACK())  //判断从机是否应答
 164   1                      ACKflag=1;
 165   1              else 
 166   1                      ACKflag=0;
 167   1              SendByte(address);  //发送要从从机读取数据的地址
 168   1              ReadACK();
 169   1              IICStart();
 170   1              SendByte(0xa0+1);  //发送从机地址和读数据
 171   1              if(ReadACK())  //判断从机是否应答
 172   1                      ACKflag=1;
 173   1              else 
 174   1                      ACKflag=0;
 175   1              dat=ReceiveByte();
 176   1              SendACK(1);
 177   1              IICStop();
 178   1              return(dat);
 179   1      }
C51 COMPILER V8.06   IIC                                                                   07/12/2020 11:51:06 PAGE 4   

 180          
 181          void main()
 182          {
 183   1              time0Init();
 184   1              EA=0;
 185   1              Write(3,0x03);   //写入的地址和数据
 186   1              delay1(5);
 187   1              num=Read(2);     //读该地址中的数据
 188   1              EA=1;
 189   1              while(1);
 190   1      }
 191          
 192          void time() interrupt 1
 193          {       
 194   1              TH0=0xee;
 195   1              TL0=0x00;
 196   1              display(num);
 197   1      }
 198          
 199          
 200          
 201          
 202          
 203          
 204          
 205          
 206          
 207          
 208          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    425    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
